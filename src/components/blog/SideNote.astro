---
interface Props {
  note: string;
}

const { note } = Astro.props;

// Simple markdown parser for bold and italic
const parseMarkdown = (text: string) => {
  return (
    text
      // Bold: **text** or __text__
      .replace(/\*\*(.+?)\*\*/g, '<b>$1</b>')
      .replace(/__(.+?)__/g, '<b>$1</b>')
      // Italic: *text* or _text_
      .replace(/\*(.+?)\*/g, '<i>$1</i>')
      .replace(/_(.+?)_/g, '<i>$1</i>')
  );
};

const parsedNote = parseMarkdown(note);
---

<span class="sidenote-wrapper relative inline cursor-help">
  <span class="sidenote-trigger text-white font-bold">
    <slot />
  </span>

  <span
    class="sidenote-content fixed sidenote:w-64 p-4 bg-rose-950 sidenote:bg-sasquatch-socks/10 text-white sidenote:text-right max-sidenote:border-t-10 sidenote:border-r-10 border-sasquatch-socks text-base leading-relaxed opacity-0 pointer-events-none transition-opacity duration-200 z-10 sidenote:block font-normal"
    role="tooltip"
    set:html={parsedNote}
  />
</span>

<style>
  .sidenote-trigger {
    background: linear-gradient(
      to bottom,
      transparent 0%,
      transparent 50%,
      var(--color-blinking-blue) 50%,
      var(--color-blinking-blue) 100%
    );
  }

  .sidenote-trigger:hover {
    background: linear-gradient(
      to bottom,
      transparent 0%,
      transparent 50%,
      var(--color-sasquatch-socks) 50%,
      var(--color-sasquatch-socks) 100%
    );
  }

  .sidenote-content {
    /* Position will be set by JavaScript */
  }

  .sidenote-wrapper:hover .sidenote-content {
    opacity: 1;
  }

  /* Mobile: Show as full-width tooltip below text */
  @media (max-width: 1479px) {
    .sidenote-content {
      position: fixed;
      right: 1rem;
      left: 1rem;
      width: auto;
      max-width: none;
    }
  }
</style>

<script>
  // Update sidenote position on scroll and initially
  function updateSidenotePositions() {
    // Find the prose container to calculate the right edge
    const proseContainer = document.querySelector('.prose') as HTMLElement;
    const proseRect = proseContainer.getBoundingClientRect();

    document.querySelectorAll('.sidenote-wrapper').forEach((wrapper) => {
      const rect = wrapper.getBoundingClientRect();
      const content = wrapper.querySelector('.sidenote-content') as HTMLElement;

      if (!content) return;
      if (!proseContainer) return;
      if (window.innerWidth >= 1480) {
        const noteRect = content.getBoundingClientRect();

        // Position vertically aligned with the trigger text
        content.style.top = `${rect.top - 8}px`;

        // Position horizontally: right edge of prose + gap
        content.style.left = `${proseRect.left - noteRect.width}px`;
      } else {
        // Mobile: position below the trigger text, full width with margins
        content.style.top = `${rect.bottom + 8}px`;
        content.style.left = '';
        content.style.right = '';
        content.style.transform = 'none';
      }
    });
  }

  // Run on load and scroll
  if (typeof window !== 'undefined') {
    updateSidenotePositions();
    window.addEventListener('scroll', updateSidenotePositions);
    window.addEventListener('resize', updateSidenotePositions);
  }
</script>
