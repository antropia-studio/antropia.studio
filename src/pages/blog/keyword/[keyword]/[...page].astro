---
import { getCollection } from "astro:content";
import BlogList from "../../../../layouts/blog/BlogList.astro";
import {
  POSTS_PER_PAGE,
  slugifyKeyword,
  deslugifyKeyword,
} from "../../../../consts";

export async function getStaticPaths({ paginate }: { paginate: Function }) {
  const allPosts = (await getCollection("blog")).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
  );

  const keywords = [
    ...new Set(allPosts.flatMap((post) => post.data.keywords ?? [])),
  ];

  return keywords.flatMap((keyword) => {
    const filtered = allPosts.filter((post) =>
      post.data.keywords?.includes(keyword),
    );
    return paginate(filtered, {
      params: { keyword: slugifyKeyword(keyword) },
      pageSize: POSTS_PER_PAGE,
    });
  });
}

const { page } = Astro.props;
const { keyword } = Astro.params;

---

<BlogList
  posts={page.data}
  page={page}
  activeKeyword={deslugifyKeyword(keyword!)}
/>
